name: Append Today Dart Log

on:
  workflow_dispatch:    # ÏàòÎèô Ïã§ÌñâÏùÑ ÏúÑÌïú Ìä∏Î¶¨Í±∞

jobs:
  append-log:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set current date
        run: echo "NOW=$(date '+%Y-%m-%d %H:%M')" >> $GITHUB_ENV

      - name: Pull latest to avoid conflicts
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git pull --rebase || true

      - name: Append modified Dart files to log
        run: |
          mkdir -p gpt_context
          LOG_FILE="gpt_context/today_log.md"
          echo "" >> $LOG_FILE
          echo "## üïí $NOW" >> $LOG_FILE
          echo "" >> $LOG_FILE

          # ÌååÏùº Î™©Î°ù Ï∂îÏ∂ú
          FILES=$(git diff --name-only --diff-filter=ACM $(git log --since=midnight -1 --format=%H) | grep '\.dart$' | sort)

          # Î≥ÄÍ≤ΩÎêú ÌååÏùºÏù¥ ÏóÜÎã§Î©¥ Ï¢ÖÎ£å
          if [ -z "$FILES" ]; then
            echo "No Dart file changes today."
            exit 0
          fi

          # ÏàòÏ†ïÎêú ÌååÏùºÏùÑ Î°úÍ∑∏Ïóê Ï∂îÍ∞Ä
          echo "$FILES" | sed 's/^/- /' >> $LOG_FILE

      - name: Commit and push updated log
        run: |
          git add gpt_context/today_log.md
          git commit -m "docs: update Dart log @ $NOW" || echo "‚ö†Ô∏è No changes to commit"
          git push || echo "‚ö†Ô∏è Push failed (possibly no new commit)"
